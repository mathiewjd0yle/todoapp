<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title style="color: #ffffff;">To‑Do List</title>
<link rel="icon" href="../images/favicon.ico">
<meta name="theme-color" content="#8a2f00">
<style>
    html, body { height: 100%; }
    body {
        font-family: Arial, sans-serif;
        background: #031a42;
        background-image: url('../images/appbackground.jpg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
        color: #fff;
        position: relative;
    }
    body::before {
        content: "";
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.35);
        pointer-events: none;
        z-index: 0;
        transition: background 150ms linear;
    }
    .todo-container {
        --accent: #8a2f00; 
        --accent-opaque: rgba(138,47,0,0.9);
        --accent-subtle: rgba(138,47,0,0.12);
        --accent-border: rgba(138,47,0,0.28);

        background: rgba(197, 71, 3, 0.45);
        padding: 20px;
        border-radius: 8px;
        width: 350px;
        box-shadow: 0 4px 8px rgba(2, 11, 79, 0.1);
        color: #000;
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
        position: relative;
        z-index: 1;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
    }

    h2 {
        text-align: center;
        margin-bottom: 20px;
        color: #000;
    }
    .date-controls {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 12px;
    }
    .small-btn {
        background: transparent;
        border: 1px solid var(--accent-border);
        color: #000;
        padding: 4px 6px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    .small-btn:hover { background: rgba(138,47,0,0.06); }
    .input-group {
        display: flex;
        margin-bottom: 15px;
    }
    input[type="text"] {
        flex: 1;
        padding: 10px;
        border: 1px solid var(--accent-border);
        border-radius: 4px 0 0 4px;
        outline: none;
        background: rgba(255,255,255,0.03);
        color: #000;
    }
    input[type="text"]::placeholder { color: rgba(0,0,0,0.5); }
    button {
        padding: 6px 8px;
        border: 1px solid var(--accent-border);
        background: transparent;
        color: #000;
        cursor: pointer;
        border-radius: 0 4px 4px 0;
        font-size: 12px;
        transition: background 120ms linear, border-color 120ms linear;
    }
    button:hover {
        background: rgba(138,47,0,0.06);
        border-color: rgba(138,47,0,0.18);
    }
    ul {
        list-style: none;
        padding: 0;
    }
    li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        border-bottom: 1px solid var(--accent-border);
        color: #000;
    }
    li.completed span {
        text-decoration: line-through;
        color: rgba(138,47,0,0.6);
    }
    .subtasks-container {
        margin-top: 6px;
        padding-left: 8px;
    }
    .subtask-list { list-style: none; padding-left: 0; margin: 0 0 6px 0; }
    .subtask { display:flex; justify-content:space-between; align-items:center; padding:2px 0; }
    .subtask span { font-size: 12px; color: #000; }
    .subtask.completed span { text-decoration: line-through; color: rgba(0,0,0,0.6); }
    .expand-btn { background: transparent; border: none; color: #000; cursor: pointer; font-size: 11px; padding: 0 2px; }
    .subtask-input { display:flex; gap:6px; }
    .subtask-input input { flex:1; padding:4px; border-radius:4px; border:1px solid var(--accent-border); background: rgba(255,255,255,0.02); color: #000; font-size: 12px; }
    .subtask-input input::placeholder { color: rgba(0,0,0,0.5); }
    .subtask-input button { padding:3px 6px; border-radius:4px; background:transparent; color: #000; border:1px solid var(--accent-border); cursor:pointer; font-size:11px; }
    .subtask-input button:hover { background: rgba(138,47,0,0.06); }
    .delete-btn {
        background: transparent;
        border: 1px solid var(--accent-border);
        color: #000;
        padding: 1px 4px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 10px;
        line-height: 1;
    }
    .delete-btn:hover {
        background: rgba(138,47,0,0.12);
        border-color: rgba(138,47,0,0.18);
    }
    .task-delete { margin-left: 10px; }
    input[type="checkbox"] { transform: scale(0.75); vertical-align: middle; margin-right:4px; }
    .todo-container span { color: #000; }
    .subtask div { gap:4px; }

</style>
</head>
<body>

<div class="todo-container">
    <h2>To‑Do List</h2>
    <div class="date-controls">
        <button id="prevDayBtn" class="small-btn">‹</button>
        <input type="date" id="dateInput">
        <button id="nextDayBtn" class="small-btn">›</button>
        <button id="todayBtn" class="small-btn">Today</button>
        <button id="cleanupBtn" class="small-btn" title="Remove lists older than 14 days">Cleanup</button>
    </div>

    <div class="input-group">
        <input type="text" id="taskInput" placeholder="Add a new task...">
        <button id="addTaskBtn">Add</button>
    </div>
    <div id="message" style="font-size:12px; margin-top:6px; color: rgba(0,0,0,0.75);"></div>
    <ul id="taskList"></ul> 
</div>

<script>
    const STORAGE_KEY = 'dailyLists';
    const RETENTION_DAYS = 14;
    let selectedDateKey = formatDateKey(new Date());

    document.addEventListener('DOMContentLoaded', () => {
        const dateInput = document.getElementById('dateInput');
        dateInput.value = selectedDateKey;
        document.getElementById('prevDayBtn').onclick = () => changeDate(-1);
        document.getElementById('nextDayBtn').onclick = () => changeDate(1);
        document.getElementById('todayBtn').onclick = () => { selectedDateKey = formatDateKey(new Date()); dateInput.value = selectedDateKey; loadTasks(); };
        dateInput.onchange = () => { selectedDateKey = dateInput.value; loadTasks(); };
        document.getElementById('cleanupBtn').onclick = () => { const removed = cleanupOldLists(); if (removed) showMessage(`${removed} old lists removed`); else showMessage('No old lists to remove'); };
        document.getElementById('addTaskBtn').onclick = addTask;

        migrateOldTasks();
        const removed = cleanupOldLists();
        if (removed) showMessage(`${removed} old lists removed`);
        loadTasks();
    });


    function resizeImageToDataUrl(file, maxWidth = 1200, quality = 0.8) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                const img = new Image();
                img.onload = () => {
                    const ratio = img.width / img.height;
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        width = maxWidth;
                        height = Math.round(width / ratio);
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(dataUrl);
                };
                img.onerror = reject;
                img.src = reader.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function showMessage(msg, timeout = 3000) {
        const el = document.getElementById('message');
        if (!el) return;
        el.textContent = msg;
        clearTimeout(el._t);
        el._t = setTimeout(() => el.textContent = '', timeout);
    }

    function formatDateKey(date) {
        const d = new Date(date);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    }

    function changeDate(offset) {
        const dateInput = document.getElementById('dateInput');
        const base = selectedDateKey || (dateInput && dateInput.value) || formatDateKey(new Date());
        const d = new Date(base + 'T00:00:00');
        d.setDate(d.getDate() + offset);
        selectedDateKey = formatDateKey(d);
        if (dateInput) dateInput.value = selectedDateKey;
        loadTasks();
    }

    function getDailyLists() {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
    }

    function saveDailyLists(lists) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(lists));
    }

    function migrateOldTasks() {
        const old = JSON.parse(localStorage.getItem('tasks')) || [];
        if (!old.length) return;
        const lists = getDailyLists();
        lists[selectedDateKey] = lists[selectedDateKey] || [];
        old.forEach(t => {
            if (!t.id) t.id = generateId();
            t.subtasks = t.subtasks || [];
            t.subtasks = t.subtasks.map(s => { if (!s.id) s.id = generateId(); return s; });
            lists[selectedDateKey].push(t);
        });
        localStorage.removeItem('tasks');
        saveDailyLists(lists);
        showMessage(`Migrated ${old.length} tasks to ${selectedDateKey}`);
    }

    function cleanupOldLists() {
        const lists = getDailyLists();
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - RETENTION_DAYS);
        let removed = 0;
        Object.keys(lists).forEach(k => {
            const d = new Date(k + 'T00:00:00');
            if (d < cutoff) { delete lists[k]; removed++; }
        });
        if (removed) saveDailyLists(lists);
        return removed;
    }

    function loadTasks() {
        const lists = getDailyLists();
        const tasks = lists[selectedDateKey] || [];
        const listEl = document.getElementById('taskList');
        listEl.innerHTML = '';
        tasks.forEach(renderTask);
    }

    function generateId() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }

    function addTask() {
        const input = document.getElementById('taskInput');
        const taskText = input.value.trim();
        if (taskText === '') { alert('Please enter a task.'); return; }
        const task = { id: generateId(), text: taskText, completed: false, subtasks: [] };
        let lists = getDailyLists();
        lists[selectedDateKey] = lists[selectedDateKey] || [];
        lists[selectedDateKey].push(task);
        saveDailyLists(lists);
        renderTask(task);
        input.value = '';
    }

    function renderTask(task) {
        const list = document.getElementById('taskList');
        const li = document.createElement('li');
        li.dataset.id = task.id;
        if (task.completed) li.classList.add('completed');

        const left = document.createElement('div');
        left.style.display = 'flex';
        left.style.alignItems = 'center';
        left.style.gap = '8px';

        const expandBtn = document.createElement('button');
        expandBtn.textContent = task.subtasks && task.subtasks.length ? '▾' : '▸';
        expandBtn.className = 'expand-btn';
        expandBtn.onclick = () => {
            const cont = li.querySelector('.subtasks-container');
            if (cont) {
                const open = cont.style.display !== 'none';
                cont.style.display = open ? 'none' : 'block';
                expandBtn.textContent = open ? '▸' : '▾';
            }
        };

        const span = document.createElement('span');
        span.textContent = task.text;
        span.onclick = () => toggleComplete(task.id, li);

        left.appendChild(expandBtn);
        left.appendChild(span);

        const delBtn = document.createElement('button');
        delBtn.textContent = 'X';
        delBtn.className = 'delete-btn task-delete';
        delBtn.onclick = () => deleteTask(task.id, li);

        li.appendChild(left);
        li.appendChild(delBtn);

        const subtasksContainer = document.createElement('div');
        subtasksContainer.className = 'subtasks-container';
        subtasksContainer.style.display = task.subtasks && task.subtasks.length ? 'block' : 'none';

        const sublist = document.createElement('ul');
        sublist.className = 'subtask-list';
        if (task.subtasks) {
            task.subtasks.forEach(s => { renderSubtask(sublist, task.id, s); });
        }

        const addSubWrap = document.createElement('div');
        addSubWrap.className = 'subtask-input';
        const subInput = document.createElement('input');
        subInput.type = 'text';
        subInput.placeholder = 'Add a subtask...';
        const addSubBtn = document.createElement('button');
        addSubBtn.textContent = 'Add';
        addSubBtn.onclick = () => {
            const text = subInput.value.trim();
            if (!text) return;
            addSubtask(task.id, text, sublist, subtasksContainer, expandBtn);
            subInput.value = '';
        };

        addSubWrap.appendChild(subInput);
        addSubWrap.appendChild(addSubBtn);

        subtasksContainer.appendChild(sublist);
        subtasksContainer.appendChild(addSubWrap);

        li.appendChild(subtasksContainer);
        list.appendChild(li);
    }

    function renderSubtask(sublist, taskId, subtask) {
        const sli = document.createElement('li');
        sli.className = 'subtask';
        sli.dataset.subid = subtask.id;
        if (subtask.completed) sli.classList.add('completed');

        const left = document.createElement('div');
        left.style.display = 'flex';
        left.style.alignItems = 'center';
        left.style.gap = '8px';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = !!subtask.completed;
        checkbox.onchange = () => toggleSubtask(taskId, subtask.id, sli, checkbox.checked);

        const span = document.createElement('span');
        span.textContent = subtask.text;

        left.appendChild(checkbox);
        left.appendChild(span);

        const del = document.createElement('button');
        del.textContent = 'X';
        del.className = 'delete-btn';
        del.onclick = () => deleteSubtask(taskId, subtask.id, sli);

        sli.appendChild(left);
        sli.appendChild(del);
        sublist.appendChild(sli);
    }

    function addSubtask(taskId, text, sublist, cont, expandBtn) {
        const lists = getDailyLists();
        const task = (lists[selectedDateKey] || []).find(t => t.id === taskId);
        if (!task) return;
        const subtask = { id: generateId(), text, completed: false };
        task.subtasks = task.subtasks || [];
        task.subtasks.push(subtask);
        saveDailyLists(lists);
        renderSubtask(sublist, taskId, subtask);
        cont.style.display = 'block';
        expandBtn.textContent = '▾';
    }

    function toggleSubtask(taskId, subId, sli, checked) {
        const lists = getDailyLists();
        const task = (lists[selectedDateKey] || []).find(t => t.id === taskId);
        if (!task) return;
        task.subtasks = task.subtasks || [];
        const sub = task.subtasks.find(s => s.id === subId);
        if (!sub) return;
        sub.completed = checked;
        saveDailyLists(lists);
        sli.classList.toggle('completed', !!sub.completed);
    }

    function toggleComplete(taskId, li) {
        const lists = getDailyLists();
        const task = (lists[selectedDateKey] || []).find(t => t.id === taskId);
        if (!task) return;
        task.completed = !task.completed;
        saveDailyLists(lists);
        li.classList.toggle('completed');
    }

    function deleteSubtask(taskId, subId, sli) {
        const lists = getDailyLists();
        const task = (lists[selectedDateKey] || []).find(t => t.id === taskId);
        if (!task) return;
        task.subtasks = (task.subtasks || []).filter(s => s.id !== subId);
        saveDailyLists(lists);
        sli.remove();
    }

    function deleteTask(taskId, li) {
        const lists = getDailyLists();
        lists[selectedDateKey] = (lists[selectedDateKey] || []).filter(t => t.id !== taskId);
        saveDailyLists(lists);
        li.remove();
    }
</script>

</body>
</html>
